AWSTemplateFormatVersion: "2010-09-09"
Description: "Network stack for app-evently"

Parameters:
    ProjectName:
        Type: String
        Default: app-evently
    Environment:
        Type: String
        Default: dev

Resources:
    VPC:
        Type: AWS::EC2::VPC
        Properties:
            CidrBlock: 10.0.0.0/16
            EnableDnsHostnames: true
            EnableDnsSupport: true
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-vpc

    PublicSubnet1:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            CidrBlock: 10.0.1.0/24
            AvailabilityZone: !Select [0, !GetAZs ""]
            MapPublicIpOnLaunch: true
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-public-subnet-1

    PublicSubnet2:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            CidrBlock: 10.0.2.0/24
            AvailabilityZone: !Select [1, !GetAZs ""]
            MapPublicIpOnLaunch: true
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-public-subnet-2

    PrivateSubnet1:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            CidrBlock: 10.0.3.0/24
            AvailabilityZone: !Select [0, !GetAZs ""]
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-private-subnet-1

    PrivateSubnet2:
        Type: AWS::EC2::Subnet
        Properties:
            VpcId: !Ref VPC
            CidrBlock: 10.0.4.0/24
            AvailabilityZone: !Select [1, !GetAZs ""]
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-private-subnet-2

    EIP:
        Type: AWS::EC2::EIP
        Properties:
            Domain: vpc

    NATGateway:
        Type: AWS::EC2::NatGateway
        Properties:
            AllocationId: !GetAtt EIP.AllocationId
            SubnetId: !Ref PublicSubnet1

    InternetGateway:
        Type: AWS::EC2::InternetGateway
        Properties:
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-igw

    AttachGateway:
        Type: AWS::EC2::VPCGatewayAttachment
        Properties:
            VpcId: !Ref VPC
            InternetGatewayId: !Ref InternetGateway

    PublicRouteTable:
        Type: AWS::EC2::RouteTable
        Properties:
            VpcId: !Ref VPC
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-public-rt

    PublicRoute:
        Type: AWS::EC2::Route
        DependsOn: AttachGateway
        Properties:
            RouteTableId: !Ref PublicRouteTable
            DestinationCidrBlock: 0.0.0.0/0
            GatewayId: !Ref InternetGateway

    PublicSubnet1RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
            SubnetId: !Ref PublicSubnet1
            RouteTableId: !Ref PublicRouteTable

    PublicSubnet2RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
            SubnetId: !Ref PublicSubnet2
            RouteTableId: !Ref PublicRouteTable

    PrivateRouteTable:
        Type: AWS::EC2::RouteTable
        Properties:
            VpcId: !Ref VPC
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-private-rt

    PrivateRoute:
        Type: AWS::EC2::Route
        Properties:
            RouteTableId: !Ref PrivateRouteTable
            DestinationCidrBlock: 0.0.0.0/0
            NatGatewayId: !Ref NATGateway

    PrivateSubnet1RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
            SubnetId: !Ref PrivateSubnet1
            RouteTableId: !Ref PrivateRouteTable

    PrivateSubnet2RouteTableAssociation:
        Type: AWS::EC2::SubnetRouteTableAssociation
        Properties:
            SubnetId: !Ref PrivateSubnet2
            RouteTableId: !Ref PrivateRouteTable

    # Security Group para Route53 Resolver
    ResolverSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Security group for Route53 Resolver
            VpcId: !Ref VPC
            SecurityGroupIngress:
                - IpProtocol: udp
                  FromPort: 53
                  ToPort: 53
                  CidrIp: 10.0.0.0/16
                - IpProtocol: tcp
                  FromPort: 53
                  ToPort: 53
                  CidrIp: 10.0.0.0/16

    # Route53 Resolver Endpoint simplificado
    ResolverEndpoint:
        Type: AWS::Route53Resolver::ResolverEndpoint
        Properties:
            Direction: INBOUND
            IpAddresses:
                - SubnetId: !Ref PrivateSubnet1
                - SubnetId: !Ref PrivateSubnet2
            SecurityGroupIds:
                - !Ref ResolverSecurityGroup
            Name: !Sub ${ProjectName}-${Environment}-resolver

    ECSCluster:
        Type: AWS::ECS::Cluster
        Properties:
            ClusterName: !Sub ${ProjectName}-${Environment}-cluster
            Tags:
                - Key: Name
                  Value: !Sub ${ProjectName}-${Environment}-cluster

    PrivateNamespace:
        Type: AWS::ServiceDiscovery::PrivateDnsNamespace
        Properties:
            Name: !Sub ${ProjectName}.local
            Vpc: !Ref VPC
            Description: !Sub Service discovery namespace for ${ProjectName}

Outputs:
    VpcId:
        Description: VPC ID
        Value: !Ref VPC
        Export:
            Name: !Sub ${ProjectName}-${Environment}-vpc-id

    PublicSubnet1:
        Description: Public Subnet 1
        Value: !Ref PublicSubnet1
        Export:
            Name: !Sub ${ProjectName}-${Environment}-public-subnet-1

    PublicSubnet2:
        Description: Public Subnet 2
        Value: !Ref PublicSubnet2
        Export:
            Name: !Sub ${ProjectName}-${Environment}-public-subnet-2

    PrivateSubnet1:
        Description: Private Subnet 1
        Value: !Ref PrivateSubnet1
        Export:
            Name: !Sub ${ProjectName}-${Environment}-private-subnet-1

    PrivateSubnet2:
        Description: Private Subnet 2
        Value: !Ref PrivateSubnet2
        Export:
            Name: !Sub ${ProjectName}-${Environment}-private-subnet-2

    ClusterName:
        Description: ECS Cluster Name
        Value: !Ref ECSCluster
        Export:
            Name: !Sub ${ProjectName}-${Environment}-cluster-name

    NamespaceId:
        Description: Service Discovery Namespace ID
        Value: !GetAtt PrivateNamespace.Id
        Export:
            Name: !Sub ${ProjectName}-${Environment}-namespace-id
